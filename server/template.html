<!DOCTYPE HTML>
<html>

<head>
	<link rel="stylesheet" type="text/css" href="/static/rtns.css" />
	<script type="text/javascript" src="/static/canvasjs.min.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 
    <title>Real Time Node Supervision</title>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//notifyjs.com/dist/notify-combined.min.js"></script>
	<script type="text/javascript">
	window.onload = function () {

		$( "#statusConnected" ).hide();

		// WS Server url
		var ws_server_url = "{{ ws_server_url }}"

        // Chart max points
        var chartSize = 120;
        
        // StatsAvailable
        var statsAvailable = {};
        
		// dataPoints
        var dataPoints = {};

		var chart = [];
        var chartData = [];

        function chartDataAdd ( node, nodechart, name, values){
            chartData[node][nodechart].push({ 
                        type: "line",
                        xValueType: "dateTime",
                        showInLegend: true,
                        name: name,
                        dataPoints: values
                    });
        }

        function addChart (node, nodechart){
            chart[node][nodechart] = new CanvasJS.Chart("chartContainer-"+node+"-"+nodechart,{
                zoomEnabled: true,
                title: {
                    text: node + "(" + nodechart	+ ")"
                },
                toolTip: {
                    shared: true
                    
                },
                legend: {
                    verticalAlign: "top",
                    horizontalAlign: "center",
                                    fontSize: 14,
                    fontWeight: "bold",
                    fontFamily: "calibri",
                    fontColor: "dimGrey"
                },
                axisY:{
                    prefix: '%',
                    includeZero: true
                }, 
                data: chartData[node][nodechart],
            });
        }
        
        open_websocket();

		var ws;
        function open_websocket(){            
            ws = new WebSocket(ws_server_url);
            ws.onopen = function() {
                console.log('Connected.');
				$( "#statusConnected" ).show('slow');
				$( "#statusNotConnected" ).hide('slow');
            };
            ws.onmessage = function(event) {
                wsmsg = JSON.parse(event.data);
                //~ We got a message
                if(wsmsg._msg){
                    console.log("Server said: "+wsmsg._msg);
                //~ We got a nodes list
                }else if(wsmsg._nodes_list){
                    console.log("Server said: "+"The actual nodes list is: "+wsmsg._nodes_list);
                    for ( nodeId in wsmsg._nodes_list ){
						addNode(wsmsg._nodes_list[nodeId]);
					}
                //~ We got a stats list for a node
                }else if(wsmsg._nodes_stats){
					for ( var node in wsmsg._nodes_stats){
						$.each(wsmsg._nodes_stats[node].sort(),function(index,value) {
							vs = value.split("_");
							if(!(node in statsAvailable)){ statsAvailable[node] = {}; }
							if(!(vs[1] in statsAvailable[node])){ statsAvailable[node][vs[1]] = []; }
							if(!(statsAvailable[node][vs[1]].indexOf(vs[2])>-1)){
								statsAvailable[node][vs[1]].push(vs[2]); }
						});
						for (var item in statsAvailable[node]){
							addChartNodeItem(node,item);
						}
					}
                //~ We got a node added
                }else if(wsmsg._nodes_add){
					$.notify("Server said: "+"Node "+node+" is added", "info");
					addNode(wsmsg._nodes_add);
                //~ We got a nodes remove
                }else if(wsmsg._nodes_rem){
					$.notify("Server said: "+"Node "+wsmsg._nodes_rem+" is removed", "info");
					removeNode(wsmsg._nodes_add);
                //~ We got a new value
                }else{
					//~ console.log(wsmsg);
                    key = Object.keys(wsmsg)[0];
                    [node,nodechart,stat] = key.split('_');
                    val = wsmsg[key].split('/');
                    dataPoints[node][nodechart][stat].values.push({
                        x: parseInt(val[0]),
                        y: parseInt(val[1]),
                    });
                    
                    if ( dataPoints[node][nodechart][stat].values.length > chartSize ){
                        dataPoints[node][nodechart][stat].values.shift();}
                    chart[node][nodechart].render();
                }
            };
            ws.onclose = function() {
                $.notify("Server is closed.",{'className': 'error', 'autoHideDelay': 60000});
				$( "#statusConnected" ).hide('slow');
				$( "#statusNotConnected" ).show('slow');
            };
        }
        
        function askNodeStats(node){
			console.log('ask stats for node: '+node);
			ws.send(JSON.stringify({listStats: node}));
		}
        
        function addNode ( node ){
            $( "#nodesList" ).append( 	'<div id="nodeList-'+node+'" class="node">'+node+"</div>" );
			$( '#nodeList-'+node).click(function(){
					if(dataPoints[node] === undefined){
						$( "#startupMessage" ).hide();
						addChartNode(node);
						dataPoints[node] = {};
						chart[node]={};
						chartData[node]= {};
						askNodeStats(node);
						$('#nodeList-'+node).css('font-weight', 'bold');
						$.notify("Node "+node+" added to supervision", "info");
					}else{
						removeChartNode(node);
						delete dataPoints[node];
						if (Object.keys(dataPoints).length == 0){
							$( "#startupMessage" ).show();}
						delete chart[node];
						delete chartData[node];
						$('#nodeList-'+node).css('font-weight', 'normal');
						$.notify("Node "+node+" remove from supervision", "info");
					}
				});
			}
			
        function removeNode( node ){
            $( '#nodeList-'+node ).remove();}
			
        function addChartNode ( node ){
            $( "#chartContainer" ).append( 	'<div id="chartTopContainer-'+node+'">'+
												'<h2 id="chartTitleContainer-'+node+'">'+node+'</h2>'+
												'<div id="chartStats-'+node+'"></div>'+
												'<div id="chartContainer-'+node+'" class="chartContainer"></div>'+
											'</div>'
											);
			$( "#chartTitleContainer-"+node ).click(function(){
					$( "#chartStats-"+node ).toggle('slow');
					$( "#chartContainer-"+node ).toggle('slow');
			});
		}
        
        function addChartNodeItem ( node, item ){
            $( "#chartStats-"+node ).append( 	'<span id="chartStats-'+node+'-'+item+'" class="item">'+
												item+
											'</span>'
											);
			$('#chartStats-'+node+'-'+item).click(function(){
					if(dataPoints[node][item] === undefined){
						chartData[node][item] = [];
						dataPoints[node][item]={};
						addChartInNode(node,item);
						$.each(statsAvailable[node][item],function(index,stat) {
							dataPoints[node][item][stat] = { 'name' : item+'_'+stat, 'values' : [] };
							console.log("subscribe: "+node+"_"+item+"_"+stat)
							ws.send(JSON.stringify({subscribe: node+"_"+item+"_"+stat}));
							chartDataAdd ( node, item,
										dataPoints[node][item][stat].name,
										dataPoints[node][item][stat].values);
						});
						addChart(node, item);
						$('#chartStats-'+node+'-'+item).css('font-weight', 'bold');
						$.notify("Item "+item+" added to "+node, "info");
					}else{
						console.log(dataPoints[node][item]);
						for (var stat in dataPoints[node][item]){
							console.log("Unsubscribe: "+node+"_"+item+"_"+stat)
							ws.send(JSON.stringify({unsubscribe: node+"_"+item+"_"+stat}));
						}
						delete dataPoints[node][item];
						delete chartData[node][item];
						$( '#chartContainer-'+node+'-'+item ).remove();
						$('#chartStats-'+node+'-'+item).css('font-weight', 'normal');
						$.notify("Item "+item+" removed to "+node, "info");
					}
				});
			}   
											
        function removeChartNode ( node ){
            $( "#chartTopContainer-"+node ).remove();}
        
        function addChartInNode ( node, chart ){
            $( "#chartContainer-"+node ).append( '<div id="chartContainer-'+node+'-'+chart+'" class="subChartContainer"></div>' );}
        
        $( "#nodesListButton" ).click(function(){
			if($("#nodesList").is(":visible")){
				$("#nodesList").hide('slow');
				$("#nodesListButton").html('&darr; servers list &darr;');
			}else{
				$("#nodesList").show('slow');
				$("#nodesListButton").html('&uarr; servers list &uarr;');
			}
		});
        
	}
	</script>
</head>
<body>
    <h1>Real Time Node Supervision</h1>
	<div id="startupMessage">Please choose a node to supervise &rArr;</div>
	<div id="nodesListButton">&uarr; servers list &uarr; </div>
	<div id="nodesList">
		</div>
	<div id="chartContainer"></div>
	<div id="statusNotConnected">Not connected</div>
	<div id="statusConnected">Connected</div>
	</div>
</body>
</html>
