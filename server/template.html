<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 
    <title>Real Time Node Supervision</title>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script type="text/javascript">
	window.onload = function () {

		// WS Server url
		var ws_server_url = "{{ ws_server_url }}"

        // Chart max points
        var chartSize = 150;
        
		// dataPoints
        var dataPoints = {};
        dataPoints["l-marvin"] = {}
        dataPoints["l-marvin"]["cpu"] = {};
        dataPoints["l-marvin"]["cpu"]["0"] = { 'name' : 'CPU 0', 'values' : [] };
        dataPoints["l-marvin"]["cpu"]["1"] = { 'name' : 'CPU 1', 'values' : [] };
        dataPoints["l-marvin"]["mem"] = {};
        dataPoints["l-marvin"]["mem"]["used"] = { 'name' : 'MEM', 'values' : [] };

        
		var chart = [];
        var chartData = [];
        
        for (var node in dataPoints){
            addChartNode(node);
            chart[node]={};
            chartData[node]= {};
            for (var nodechart in dataPoints[node]){
                chartData[node][nodechart] = [];
                addChartInNode(node,nodechart);
                for (var stat in dataPoints[node][nodechart]){
                    chartDataAdd ( node, nodechart,
                                dataPoints[node][nodechart][stat].name,
                                dataPoints[node][nodechart][stat].values);
                }
                addChart(node, nodechart);
            }
        }

        function chartDataAdd ( node, nodechart, name, values){
            chartData[node][nodechart].push({ 
                        type: "line",
                        xValueType: "dateTime",
                        showInLegend: true,
                        name: name,
                        dataPoints: values
                    });
        }

        function addChart (node, nodechart){
            chart[node][nodechart] = new CanvasJS.Chart("chartContainer-"+node+"-"+nodechart,{
                zoomEnabled: true,
                title: {
                    text: node + "(" + nodechart	+ ")"
                },
                toolTip: {
                    shared: true
                    
                },
                legend: {
                    verticalAlign: "top",
                    horizontalAlign: "center",
                                    fontSize: 14,
                    fontWeight: "bold",
                    fontFamily: "calibri",
                    fontColor: "dimGrey"
                },
                axisY:{
                    prefix: '%',
                    includeZero: true
                }, 
                data: chartData[node][nodechart],
            });
        }
        
        open_websocket();

        function open_websocket(){
            function show_message(message){
                var el = document.createElement('div');
                el.innerHTML = message;
                document.body.appendChild(el);
            }
            
            var ws = new WebSocket(ws_server_url);
            ws.onopen = function() {
                show_message('Connected.');
                for (var k in dataPoints){
                    for (var nodechart in dataPoints[node]){
                        for (var stat in dataPoints[node][nodechart]){
                            console.log({subscribe: node+"_"+nodechart+"_"+stat})
                            ws.send(JSON.stringify({subscribe: node+"_"+nodechart+"_"+stat}));
                        }
                    }
                }
            };
            ws.onmessage = function(event) {
                wsmsg = JSON.parse(event.data);
                //~ We got a message
                if(wsmsg._msg){
                    show_message(wsmsg._msg);
                //~ We got a new value
                }else{
                    key = Object.keys(wsmsg)[0];
                    [node,nodechart,stat] = key.split('_');
                    val = wsmsg[key].split('/');
                    dataPoints[node][nodechart][stat].values.push({
                        x: parseInt(val[0]),
                        y: parseInt(val[1]),
                    });
                    
                    if ( dataPoints[node][nodechart][stat].values.length > chartSize ){
                        dataPoints[node][nodechart][stat].values.shift();}
                    chart[node][nodechart].render();
                }
            };
            ws.onclose = function() {
                show_message("Closed.");
            };
        }
        
        function addChartNode ( node ){
            $( "#chartContainer" ).append( '<div id="chartContainer-'+node+'" style="height: 300px; width: 100%; display:inline-block;"></div>' );}
        
        function addChartInNode ( node, chart ){
            $( "#chartContainer-"+node ).append( '<div id="chartContainer-'+node+'-'+chart+'" style="height: 300px; width: 50%; display:inline-block;"></div>' );}
	}
	</script>
	<script type="text/javascript" src="/js/canvasjs.min.js"></script>
</head>
<body>
    <h1>Real Time Node Supervision</h1>
	<div id="chartContainer"></div>
    <h2>Messages</h2>
    <hr/>
</body>
</html>
